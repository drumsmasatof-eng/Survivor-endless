<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Survivor Endless 完全版</title>
<style>
html,body{margin:0;overflow:hidden;background:#fdf6e3;font-family:sans-serif;}
canvas{display:block;background:#fdf6e3;}
#ui{position:fixed;left:20px;top:20px;color:#000;font-size:22px;}
.bar{width:260px;height:20px;background:#ccc;margin-bottom:8px;overflow:hidden;border-radius:4px;}
.fill{height:100%;}
#hpFill{background:#0f0;}
#expFill{background:#0ff;}
#startScreen{position:fixed;inset:0;background:#fdf6e3;color:#000;display:flex;justify-content:center;align-items:center;font-size:50px;flex-direction:column;z-index:10;}
#pause,#levelup{position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,.6);color:#fff;}
#levelbox{background:#222;padding:30px;display:flex;gap:20px;font-size:30px;border-radius:8px;}
.btn{background:#444;padding:20px;cursor:pointer;border-radius:6px;}
#modeSelect{position:fixed;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;font-size:40px;background:#fdf6e3;z-index:30;gap:20px;}
</style>
</head>
<body>

<canvas id="c"></canvas>

<div id="startScreen">
<div>Survivor Endless</div>
<div>Press SPACE to Start</div>
</div>

<div id="ui">
<div>HP</div>
<div class="bar"><div id="hpFill" class="fill"></div></div>
<div>LEVEL <span id="playerLevel" style="color:#0ff;">1</span></div>
<div class="bar"><div id="expFill" class="fill"></div></div>
<div id="weaponLevels">
Pistol Lv: <span id="pistolLv">1</span> |
Grenade Lv: <span id="grenadeLv">0</span> |
Drone Lv: <span id="droneLv">0</span>
</div>
<div id="time">0s</div>
<div id="score">SCORE: 0</div>
<div id="items">ITEMS: 0</div>
</div>

<div id="levelup"><div id="levelbox"></div></div>

<div id="modeSelect">
<div style="font-size:60px;">Survivor Endless</div>
<div id="startPC" style="background:#444;color:#fff;padding:20px 40px;border-radius:10px;">Start on PC</div>
<div id="startMobile" style="background:#444;color:#fff;padding:20px 40px;border-radius:10px;">Start on Smartphone</div>
</div>

<div id="stickBase" style="position:fixed;left:80px;bottom:120px;width:180px;height:180px;border-radius:50%;background:rgba(0,0,0,0.15);display:none;z-index:21;">
<div id="stickKnob" style="position:absolute;left:50%;top:50%;width:80px;height:80px;margin-left:-40px;margin-top:-40px;border-radius:50%;background:rgba(0,0,0,0.4);"></div>
</div>

<script>
const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}
resize();addEventListener("resize",resize);

const hpFill=document.getElementById("hpFill");
const expFill=document.getElementById("expFill");
const timeUI=document.getElementById("time");
const pistolLvUI=document.getElementById("pistolLv");
const grenadeLvUI=document.getElementById("grenadeLv");
const droneLvUI=document.getElementById("droneLv");
const playerLevelUI=document.getElementById("playerLevel");
const scoreUI=document.getElementById("score");
const itemsUI=document.getElementById("items");
const levelUI=document.getElementById("levelup");
const levelbox=document.getElementById("levelbox");
const startScreen=document.getElementById("startScreen");

let keys={},mouse={x:0,y:0};
let gameStarted=false,leveling=false,gameOver=false;

addEventListener("keydown",e=>{
keys[e.key.toLowerCase()]=true;
if(!gameStarted&&e.code==="Space"){gameStarted=true;startScreen.style.display="none";}
});
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);
addEventListener("mousemove",e=>{mouse.x=e.clientX;mouse.y=e.clientY;});

let time=0,score=0,items=0;

let player={x:0,y:0,hp:100,maxHp:100,level:1,exp:0,nextExp:6,speed:3,pistolLevel:1,grenadeLevel:0,droneLevel:0};

let bullets=[],enemies=[],xpOrbs=[],drones=[];
let pistolTimer=0;

// ===== グレネード用変数 =====
let grenadeTimer=0, grenades=[];

// ===== 攻撃力関数 =====
function getPistolDamage(){ return 1*player.pistolLevel; }
function getDroneDamage(){ return 1.5*player.droneLevel; }
function getGrenadeDamage(){ return 0.15*player.grenadeLevel; }

function openLevelUp(){
leveling=true;
levelUI.style.display="flex";
levelbox.innerHTML="";
["pistol","grenade","drone"].forEach(c=>{
let div=document.createElement("div");
div.className="btn";
div.textContent=c.toUpperCase()+" UP";
div.onclick=()=>{
if(c==="pistol")player.pistolLevel++;
if(c==="grenade")player.grenadeLevel++;
if(c==="drone")player.droneLevel++;
levelUI.style.display="none";
leveling=false;
};
levelbox.appendChild(div);
});
}

function spawnEnemy(){
enemies.push({x:player.x+(Math.random()-0.5)*800,y:player.y+(Math.random()-0.5)*800,hp:10,color:"#888"});
}

function shoot(){
let dx=mouse.x-canvas.width/2,dy=mouse.y-canvas.height/2;
let d=Math.hypot(dx,dy)||1;
bullets.push({x:player.x,y:player.y,vx:dx/d*4,vy:dy/d*4,size:8,color:"#e6e600"});
}

// ===== グレネード自動発射 =====
function autoGrenade(){
if(player.grenadeLevel<=0) return;
grenadeTimer++;
if(grenadeTimer>600/player.grenadeLevel){
    grenadeTimer=0;
    if(enemies.length===0) return;
    let target=enemies.reduce((a,b)=>Math.hypot(a.x-player.x,a.y-player.y)<Math.hypot(b.x-player.x,b.y-player.y)?a:b);
    let dx=target.x-player.x,dy=target.y-player.y;
    let dist=Math.hypot(dx,dy)||1;
    grenades.push({x:player.x,y:player.y,vx:dx/dist*2,vy:dy/dist*2,timer:90,radius:0});
}
}

function update(){
if(!gameStarted||leveling||gameOver)return;

time+=1/120;

if(keys["w"])player.y-=player.speed;
if(keys["s"])player.y+=player.speed;
if(keys["a"])player.x-=player.speed;
if(keys["d"])player.x+=player.speed;

pistolTimer++;
if(pistolTimer>150/player.pistolLevel){pistolTimer=0;shoot();}

while(drones.length<player.droneLevel)drones.push({angle:Math.random()*Math.PI*2});

drones.forEach(d=>{
d.angle+=0.02;
if(Math.random()<0.02){
bullets.push({x:player.x+Math.cos(d.angle)*80,y:player.y+Math.sin(d.angle)*80,vx:Math.cos(d.angle)*2,vy:Math.sin(d.angle)*2,size:7,color:"#cc0000",fromDrone:true});
}
});

if(Math.random()<0.02)spawnEnemy();

enemies.forEach(e=>{
let dx=player.x-e.x,dy=player.y-e.y,d=Math.hypot(dx,dy)||1;
e.x+=dx/d*1.6;e.y+=dy/d*1.6;
if(d<25)player.hp-=0.05;
});

// ===== 弾の更新 =====
bullets.forEach(b=>{b.x+=b.vx;b.y+=b.vy;});

// ピストル攻撃
bullets.forEach(b=>{
enemies.forEach(e=>{
if(Math.hypot(b.x-e.x,b.y-e.y)<20) e.hp -= b.fromDrone?getDroneDamage():getPistolDamage();
});
});

// ===== グレネード更新 =====
autoGrenade();
grenades.forEach(g=>{
g.x+=g.vx;
g.y+=g.vy;
g.timer--;
if(g.timer<=0) g.exploding=true;
});
grenades=grenades.filter(g=>!g.exploding || g.radius<60);

enemies=enemies.filter(e=>{
if(e.hp<=0){
score+=10;
xpOrbs.push({x:e.x,y:e.y,size:10});
return false;
}
return true;
});

xpOrbs.forEach(o=>{
let dx=player.x-o.x,dy=player.y-o.y,d=Math.hypot(dx,dy)||1;
if(d<140){o.x+=dx/d*2;o.y+=dy/d*2;}
if(d<25){player.exp++;o.get=true;}
});
xpOrbs=xpOrbs.filter(o=>!o.get);

if(player.exp>=player.nextExp){
player.exp-=player.nextExp;
player.level++;
player.nextExp=Math.floor(player.nextExp*1.25);
openLevelUp();
}

hpFill.style.width=(player.hp/player.maxHp*100)+"%";
expFill.style.width=(player.exp/player.nextExp*100)+"%";
playerLevelUI.textContent=player.level;
pistolLvUI.textContent=player.pistolLevel;
grenadeLvUI.textContent=player.grenadeLevel;
droneLvUI.textContent=player.droneLevel;
timeUI.textContent=Math.floor(time)+"s";
scoreUI.textContent="SCORE: "+score;
itemsUI.textContent="ITEMS: "+items;
}

function draw(){
if(!gameStarted)return;
ctx.clearRect(0,0,canvas.width,canvas.height);

function cam(x,y){return[x-player.x+canvas.width/2,y-player.y+canvas.height/2];}

enemies.forEach(e=>{
let p=cam(e.x,e.y);
ctx.fillStyle=e.color;
ctx.fillRect(p[0]-15,p[1]-15,30,30);
});

ctx.save();
ctx.translate(canvas.width/2,canvas.height/2);
let ang=Math.atan2(mouse.y-canvas.height/2,mouse.x-canvas.width/2);
ctx.rotate(ang);
ctx.fillStyle="#0f0";
ctx.fillRect(-15,-15,30,30);
ctx.restore();

ctx.fillStyle="#0f0";
xpOrbs.forEach(o=>{
let p=cam(o.x,o.y);
ctx.beginPath();
ctx.arc(p[0],p[1],o.size,0,Math.PI*2);
ctx.fill();
});

ctx.fillStyle="#0000cc";
drones.forEach(d=>{
let x=player.x+Math.cos(d.angle)*80;
let y=player.y+Math.sin(d.angle)*80;
let p=cam(x,y);
ctx.beginPath();
ctx.arc(p[0],p[1],8,0,7);
ctx.fill();
});

// 弾描画
bullets.forEach(b=>{
let p=cam(b.x,b.y);
ctx.fillStyle=b.color;
ctx.beginPath();
ctx.arc(p[0],p[1],b.size,0,Math.PI*2);
ctx.fill();
});

// グレネード描画
grenades.forEach(g=>{
if(g.exploding){
g.radius+=2;
ctx.fillStyle="rgba(255,165,0,"+(1-g.radius/60)+")";
let p=[g.x-player.x+canvas.width/2,g.y-player.y+canvas.height/2];
ctx.beginPath();
ctx.arc(p[0],p[1],g.radius,0,Math.PI*2);
ctx.fill();
}
});
}

function loop(){update();draw();requestAnimationFrame(loop);}
loop();

/* ===== スマホスティック ===== */
const startPC=document.getElementById("startPC");
const startMobile=document.getElementById("startMobile");
const modeSelect=document.getElementById("modeSelect");
const stickBase=document.getElementById("stickBase");
const stickKnob=document.getElementById("stickKnob");

let stickActive=false,stickCenter={x:0,y:0};

startPC.onclick=()=>{
gameStarted=true;
modeSelect.style.display="none";
startScreen.style.display="none";
};

startMobile.onclick=()=>{
gameStarted=true;
modeSelect.style.display="none";
startScreen.style.display="none";
stickBase.style.display="block";
};

stickBase.addEventListener("touchstart",()=>{
stickActive=true;
const r=stickBase.getBoundingClientRect();
stickCenter.x=r.left+r.width/2;
stickCenter.y=r.top+r.height/2;
});

addEventListener("touchmove",e=>{
if(!stickActive)return;
const t=e.touches[0];
let dx=t.clientX-stickCenter.x;
let dy=t.clientY-stickCenter.y;
const max=60;
const dist=Math.hypot(dx,dy);
if(dist>max){dx*=max/dist;dy*=max/dist;}
stickKnob.style.transform=`translate(${dx}px,${dy}px)`;
keys["w"]=dy<-10;
keys["s"]=dy>10;
keys["a"]=dx<-10;
keys["d"]=dx>10;
});

addEventListener("touchend",()=>{
stickActive=false;
stickKnob.style.transform="translate(0px,0px)";
keys["w"]=keys["a"]=keys["s"]=keys["d"]=false;
});
</script>
</body>
</html>
